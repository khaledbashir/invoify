# ANC Studio — Master Truth Playbook (Living Doc)
**Last updated:** 2026-01-30  
**Purpose:** One place to capture what we learned, what “correct” means, and how we ship without getting lost.

---

## 0) North Star (what we’re building)

### Problem we’re solving
- Current process is manual, slow, and error-prone (retyping specs from huge RFPs / estimator Excels into PDFs).
- The business risk is not “missing a nice UI detail” — it’s math drift, data leakage, and lost bid history.

### Success definition (non-negotiables)
- **Master Truth:** Internal Audit Excel ↔ PDF ↔ Share link never disagree (to the cent).
- **Speed:** sub‑1‑hour proposal generation; strong auto-fill where possible.
- **No leakage:** no internal costs/margins/formulas ever reach client-facing outputs.
- **Professional:** “Ferrari-grade” output aligned to ANC identity guidelines.

---

## 1) Core principles (so we don’t fuck shit up)

### 1.1 Single Source of Truth
- The **proposal data model** is the only truth.
- PDF preview, internal audit workbook, and share link are **views** derived from that model.
- If something changes, the model changes, then everything re-renders from it.

Reference: [VERIFICATION_REFINED_DESIGN.md](file:///root/natalia/invoify/VERIFICATION_REFINED_DESIGN.md)

### 1.2 Deterministic first; AI assists
- Deterministic comparison is the judge.
- AI is for explanation, location hints, and suggested fixes — not for deciding totals.

### 1.3 Rounding contract (audit-proof)
- **ROUND_HALF_EVEN**, and only at category totals (not intermediate steps).
- Always display cents.
- Use Decimal.js for comparisons; never rely on JS floating point for money.

### 1.4 “No fake UI”
- If a UI control is not functional, it must be clearly labeled as placeholder/coming soon and visually disabled.
- Default state should not display misleading numbers like `$0.00` if data is missing; show an explicit placeholder token (e.g., `[PROJECT NAME]`) or a blocking banner.

---

## 2) The two modes (and the hybrid handoff)

### 2.1 Mirror Mode (≈75% of real work)
**Intent:** “Take whatever Excel looks like and make a 1:1 PDF.”  
**Truth source at ingest:** estimator Excel (LED Sheet + Margin Analysis).  
**Canonical truth at publish:** internal audit workbook generated by the system (ugly sheet).

Mirror Mode must feel like a flight checklist:
1) Ingest Excel
2) Verify mapping + rows
3) Verify totals + rounding contract
4) Export (client PDF + internal audit Excel)

### 2.2 Intelligence Mode (≈25% of real work)
**Intent:** Start from RFP/PDF schedule, extract specs, propose configuration, then produce a budget and proposal.  
**Truth source at ingest:** client PDFs / RFP docs.  
**Canonical truth at publish:** internal audit workbook generated by the system (ugly sheet).

### 2.3 Hybrid handoff rule (universal)
- Regardless of entry mode, the “publishable state” must terminate in a system-generated internal audit workbook.
- If PDF disagrees with audit → regenerate PDF.
- If share snapshot disagrees → regenerate snapshot.

---

## 3) Mirror Mode spec (what “correct” means)

### 3.1 LED Sheet columns (A–M)
- A: Display Name
- C: Quantity
- E: MM Pitch
- F: Active Height (ft.)
- G: Active Width (ft.)
- H: Pixel Resolution (H)
- J: Pixel Resolution (W)
- M: Brightness (formerly Nits)

Rows labeled “ALT” / “Alternate” must be skipped for the base bid ingest.

### 3.2 Margin Analysis columns (A–H)
- A: Item Name / Category
- B: Cost Basis
- C: Desired Margin (%)
- D: Selling Price  `=B/(1-C)`
- E: Performance Bond `=D*0.015`
- F: B&O Tax (Morgantown) `=(D+E)*0.02`
- G: Sales Tax `=(D+E+F)*0.095`
- H: Final Total `=D+E+F+G`

Required terminal rows in this exact sequence:
- SUBTOTAL:
- TAX (9.5%):
- PROJECT TOTAL:

### 3.3 Denylist (must never appear client-side)
- Unit costs / cost basis values
- Margin percentages
- Divisor model formulas / “Natalia Math”
- Internal audit breakdown structures
- Any “blue glow” / AI provenance indicators

### 3.4 Mirror Mode gating
- Export must be blocked if:
  - mapping is invalid / required columns unreadable
  - totals disagree (to the cent) between audit and client PDF
  - invalid margin (>= 100%) is entered anywhere in editable inputs
- Warnings only (export allowed) for missing non-critical specs (e.g., missing brightness).

### 3.5 Real-world estimator example (Indiana Fever file)
We inspected: `/root/natalia/Cost Analysis - Indiana Fever - 2026-01-22.xlsx`

**Sheets present (partial):**
- `LED Cost Sheet` (not `LED Sheet`)
- `Margin Analysis`
- `P&L`, `Cash Flow`, many install sheets (HOE Install, Locker Install, etc.)

**LED Cost Sheet observed shape:**
- Header rows are multi-line (project title row, then a grouped header row, then a real column header row).
- The “brightness” concept appears as `LED NIT` / “nits” in this sample.
- The sheet includes `OPTION` column and uses rows like:
  - `Alt -Atrium Display ...`
  - `Base -Atrium Display ...`
  - Many “All‑In‑One” product rows

**Margin Analysis observed shape (this sample):**
- It is not the simple A–H tax/bond model in the abstract spec.
- It’s a sectioned table like:
  - `Hall of Excellence LED Displays`
  - columns: `Cost`, `Selling Price`, `Margin $`, `Margin %`
  - subtotal rows and an `Alternates` section
  - `TAX` and `BOND` appear as rows but are `0` in this sample
  - `SUB TOTAL (BID FORM)` row carries the main selling price total

**Implication for implementation:**
- Mirror Mode ingest/export must be robust to the real estimator formats (LED Cost Sheet + sectioned Margin Analysis).
- We should treat the “abstract A–H model” as a *target internal canonical view*, but we must parse and mirror what estimators actually deliver today.

---

## 4) Verification system (4 layers — refined)

Reference: [VERIFICATION_REFINED_DESIGN.md](file:///root/natalia/invoify/VERIFICATION_REFINED_DESIGN.md)

### Layer 1 — Excel vs calculated model
- Deterministic compare: per-screen totals + control totals.

### Layer 2 — PDF vs ugly sheet
- Validate by canonical data snapshot hashing + deterministic total comparison.

### Layer 3 — Rounding contract
- HALF_EVEN, category totals only, 2 decimals displayed, drift explainable.

### Layer 4 — “AI verification” (deterministic core + AI explanation)
- Deterministic row-by-row comparison of Excel rows vs PDF rows.
- AI only explains mismatches and proposes fixes.

---

## 5) “What’s real right now” (current state of the repo)

### 5.1 Verification studio exists
- Side-by-side Excel + PDF preview exists in Step 4 with a “scan” playback that highlights Excel rows.

### 5.2 Intelligence doc upload exists
- RFP upload is wired and stores docs, and now should route per project workspace (AnythingLLM).

### 5.3 Projects view exists
- There is a /projects “Project Vault” view listing projects.

---

## 6) Known gaps (why the experience feels confusing)

### Mirror Mode gaps
- “4 steps” aren’t always visible as a guided checklist; user doesn’t know where they are in the flow.
- Audit export may not resemble “Margin Analysis + LED Sheet” structure; can appear “blank” or not aligned with expectations.
- “OPTION” / zero-dimension rows must be treated as a blocking integrity issue, not a normal row.

### Intelligence Mode gaps
- Needs clearer separation: what is live vs placeholder vs gated.
- Needs per-workspace isolation everywhere (uploads, chats, ingest, extraction).

---

## 7) Sprint plan (ship in slices, push after each sprint)

### Sprint 0 (Alignment + foundation)
**Goal:** lock requirements, remove “fake UI”, and guarantee per-project doc isolation.  
**DoD:**
- This playbook exists.
- RFP upload is real and clearly labeled.
- RFP uploads route to per-project AnythingLLM workspace slug.
- Projects entry is visible and accessible.

### Sprint 1 (Mirror Mode end-to-end, no confusion)
**Goal:** upload Excel → see verification layers clearly → export correct PDF + correct ugly sheet.  
**DoD:**
- “Mirror Mode Flight Checklist” UI exists and matches steps.
- 4-layer verification is visible with clear gating states.
- Audit workbook output matches required tab naming/structure (LED Sheet + Margin Analysis) and is never empty.
- Export only unlocks when Layer 1–3 pass (Layer 4 can be warning with explanations if desired).

### Sprint 2 (Sanitization + share link hardening)
**Goal:** client outputs are leak-proof and stable.  
**DoD:**
- Denylist enforced for share snapshots and PDF outputs.
- Canonical snapshot hashing ensures the share link matches the audit model state.

### Sprint 3 (Intelligence Mode, consultant-grade)
**Goal:** upload RFP PDFs → extract 17/20 → gap-fill UX → produce first-pass budget without leaking.  
**DoD:**
- Clear guided flow; no fake placeholders.
- All extracted fields have provenance; human confirmation UX is clear.

### Sprint cadence
- After each sprint: lint + build must pass, then push to GitHub (EasyPanel deploy).

---

## 8) Decision log (so we don’t drift)
- Deterministic verification is the authority; AI assists.
- Single source of truth is the proposal model; all artifacts derive from it.
- Mirror Mode is the first polish target (highest ROI, 75% cases).
